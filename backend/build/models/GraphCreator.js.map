{"version":3,"file":"GraphCreator.js","names":["Papa","require","_require","getDelete","toAgeProps","QueryBuilder","GraphCreator","_ref","arguments","length","undefined","nodes","edges","graphName","dropGraph","_classCallCheck2","nodefiles","edgefiles","query","graph","drop","create","labels","_createClass2","key","value","_createNodeLabel","_asyncToGenerator2","_regenerator","mark","_callee","label","makeLabel","wrap","_context","prev","next","concat","push","stop","createNodeLabel","_x","apply","_createEdgeLabel","_callee2","_context2","createEdgeLabel","_x2","_createNode","_callee3","node","type","qbuild","CREATENODE","_args3","_context3","returnAs","clause","insertQuery","getGeneratedQuery","createNode","_x3","_x4","_createEdge","_callee4","edge","startv","startid","endv","endid","eprops","CREATEEDGE","_args4","_context4","createEdge","_x5","_x6","_createGraph","_callee5","dropgraph","creategraph","_args5","_context5","createGraph","_readData","_callee6","file","resolve","_context6","parse","complete","res","errors","forEach","e","data","splice","row","o","header","readData","_x7","_x8","_x9","_parseData","_callee7","_this","_context7","Promise","all","map","originalname","buffer","toString","sent","nodeFile","n","edgeFile","abrupt","parseData","module","exports"],"sources":["../../src/models/GraphCreator.js"],"sourcesContent":["const Papa = require('papaparse');\nconst { getDelete, toAgeProps } = require('../util/ObjectExtras');\nconst QueryBuilder = require('./QueryBuilder');\n\nclass GraphCreator {\n    constructor({nodes, edges, graphName, dropGraph}={}){\n        this.nodefiles = nodes;\n        this.edgefiles = edges;\n        this.dropGraph = dropGraph;\n        this.graphName = graphName;\n        this.nodes = [];\n        this.edges = [];\n        this.query = {\n            graph: {\n                drop: null,\n                create: null,\n            },\n            labels:[],\n            nodes: [],\n            edges: []\n        };\n    }\n    async createNodeLabel(label){\n        const makeLabel = `SELECT create_vlabel('${this.graphName}', '${label}');`\n        this.query.labels.push(makeLabel);\n    }\n\n    async createEdgeLabel(label){\n        const makeLabel = `SELECT create_elabel('${this.graphName}', '${label}');`;\n        this.query.labels.push(makeLabel); \n    }\n\n    async createNode(node, type, qbuild = new QueryBuilder({\n        graphName:this.graphName,\n        returnAs:'v'\n    })){\n        const CREATENODE = \n        `(:${type} ${toAgeProps(node)})`;\n\n        if (qbuild.clause === ''){\n            qbuild.create();\n        }\n        \n        qbuild.insertQuery(CREATENODE);\n        this.query.nodes.push(qbuild.getGeneratedQuery());\n    }\n    async createEdge(edge, type, qbuild = new QueryBuilder(\n        {\n            graphName: this.graphName,\n            returnAs: 'e'\n        }\n    )){\n        const startv = getDelete(edge, \"start_vertex_type\");\n        const startid = getDelete(edge, \"start_id\");\n        const endv = getDelete(edge, \"end_vertex_type\");\n        const endid = getDelete(edge, \"end_id\");\n        const eprops = edge;\n        const CREATEEDGE = \n        `MATCH\n            (a:${startv} {id:'${startid}'}),\n            (b:${endv} {id:'${endid}'})\n            CREATE (a)-[e:${type} ${toAgeProps(eprops)}]->(b)`;\n        \n        qbuild.insertQuery(CREATEEDGE);\n\n        this.query.edges.push(qbuild.getGeneratedQuery());\n    }\n    async createGraph(drop=false){\n        if (drop){\n            const dropgraph = `SELECT * FROM drop_graph('${this.graphName}', true);`;\n            this.query.graph.drop = dropgraph;\n        }\n        const creategraph = `SELECT * FROM create_graph('${this.graphName}');`;\n        this.query.graph.create = creategraph;\n    }\n    async readData(file, type, resolve){\n        Papa.parse(file, {\n            complete: (res) => {\n                res.errors.forEach((e)=>{\n                    if (e.type === 'FieldMismatch'){\n                        res.data.splice(e.row, 1);\n                    }\n                })\n                const o = {\n                    type,\n                    data:res.data\n                }\n                resolve(o);\n            },\n            header: true,\n        });\n    }\n    async parseData(){\n        this.createGraph(this.dropGraph);\n\n        this.nodes = await Promise.all(this.nodefiles.map((node) => new Promise((resolve) => {\n            this.createNodeLabel(node.originalname);\n            this.readData(node.buffer.toString('utf8'), node.originalname, resolve);\n        })));\n        this.nodes.forEach((nodeFile)=>{\n            nodeFile.data.forEach((n)=>{\n                this.createNode(n, nodeFile.type);\n            });\n        });\n        this.edges = await Promise.all(this.edgefiles.map((edge) => new Promise((resolve) => {\n            this.createEdgeLabel(edge.originalname);\n            this.readData(edge.buffer.toString('utf8'), edge.originalname, resolve);\n        })));\n\n        this.edges.forEach((edgeFile)=>{\n            edgeFile.data.forEach((e)=>{\n                this.createEdge(e, edgeFile.type);\n            });\n        });\n        return this.query;\n        \n    }\n};\n\nmodule.exports = GraphCreator;\n"],"mappings":"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","ignoreList":[]}